<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corridor Profile Dashboard (Fort Worth District Transportation Master Plan): Data Pipeline Documentation</title>
<style>
  :root {
    --bg-main: #ffffff;
    --bg-sidebar: #f8fafc;
    --text-main: #1f2933;
    --text-heading: #0f172a;
    --text-muted: #64748b;
    --text-link: #475569;
    --link-active: #0f62fe;
    --border-color: #e2e8f0;
    --code-bg: #f3f4f6;
    --note-bg: #eef2ff;
    --note-border: #6366f1;
    --table-header-bg: #f1f5f9;
    --table-border: #e2e8f0;
  }

  [data-theme="dark"] {
    --bg-main: #0f172a;
    --bg-sidebar: #1e293b;
    --text-main: #cbd5e1;
    --text-heading: #f8fafc;
    --text-muted: #94a3b8;
    --text-link: #94a3b8;
    --link-active: #3b82f6;
    --border-color: #334155;
    --code-bg: #1e293b;
    --note-bg: #1e1b4b;
    --note-border: #818cf8;
    --table-header-bg: #334155;
    --table-border: #475569;
  }

  body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; line-height: 1.6; color: var(--text-main); background: var(--bg-main); display: flex; transition: background 0.3s, color 0.3s; }
  .sidebar { width: 260px; height: 100vh; position: sticky; top: 0; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 2rem 1.5rem; overflow-y: auto; box-sizing: border-box; display: flex; flex-direction: column; }
  .content { flex: 1; padding: 2rem 3rem 80vh 3rem; max-width: 900px; margin: 0 auto; box-sizing: border-box; }
  h1, h2, h3 { color: var(--text-heading); }
  h1 { margin-top: 0; font-size: 1.85rem; }
  h2 { margin-top: 2.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-size: 1.5rem; }
  h3 { margin-top: 1.5rem; font-size: 1.15rem; }
  .toc-title { font-weight: 700; color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; margin-bottom: 1rem; }
  .toc-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
  .toc-list li { margin: 0.25rem 0; }
  .toc-list a { color: var(--text-link); font-size: 0.9rem; text-decoration: none; display: block; padding: 0.35rem 0.75rem; border-radius: 6px; transition: all 0.2s; }
  .toc-list a:hover { color: var(--link-active); background: var(--code-bg); }
  .toc-list a.active { color: var(--link-active); background: var(--code-bg); font-weight: 600; }
  .toc-list ul { list-style: none; padding: 0; margin: 0.25rem 0 0.5rem 0; }
  .toc-list ul li { margin: 0.15rem 0; }
  .toc-list ul a { font-size: 0.85rem; padding: 0.3rem 0.75rem 0.3rem 1.5rem; color: var(--text-muted); }
  .toc-list ul a:hover { color: var(--link-active); }
  .toc-list ul a.active { color: var(--link-active); font-weight: 500; }
  
  .theme-toggle { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: var(--text-muted); font-size: 0.85rem; background: none; border-left: none; border-right: none; border-bottom: none; width: 100%; text-align: left; }
  .theme-toggle:hover { color: var(--link-active); }
  .theme-toggle svg { width: 18px; height: 18px; fill: currentColor; }

  code { background: var(--code-bg); padding: 0.1rem 0.25rem; border-radius: 4px; color: var(--text-heading); }
  pre { background: var(--code-bg); padding: 1rem; border-radius: 6px; overflow-x: auto; border: 1px solid var(--border-color); }
  ul { padding-left: 1.25rem; }
  li { margin: 0.35rem 0; }
  a { color: var(--link-active); text-decoration: none; }
  a:hover { text-decoration: underline; }
  .note { background: var(--note-bg); border-left: 4px solid var(--note-border); padding: 0.75rem 1rem; border-radius: 6px; margin: 1.5rem 0; }
  .note strong { color: var(--text-heading); }
  
  table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
  th, td { border: 1px solid var(--table-border); padding: 0.5rem 0.75rem; text-align: left; }
  th { background: var(--table-header-bg); font-weight: 600; color: var(--text-heading); }
  tr:nth-child(even) { background: var(--code-bg); }
  
  .category-title { font-weight: 600; color: var(--text-heading); background-color: #e0e7ff !important; }
  [data-theme="dark"] .category-title { background-color: #312e81 !important; }
  
  .formula { background: var(--code-bg); padding: 0.75rem 1rem; border-radius: 6px; margin: 0.75rem 0; font-family: "Consolas", "Monaco", monospace; border-left: 3px solid var(--link-active); }
</style>

<link rel="icon" type="image/svg+xml" href="https://pine-j.github.io/FDTMP_WebAPP/Corridor_Profile/Graphics/SVG/readme_icon.svg">
</head>
<body>
<nav class="sidebar">
  <div class="toc-title">Table of Contents</div>
  <ul class="toc-list">
    <li><a href="#overview">Overview</a></li>
    <li>
      <a href="#python-script">The Python Script</a>
      <ul>
        <li><a href="#script-purpose">Script purpose</a></li>
        <li><a href="#input-files">Input files</a></li>
        <li><a href="#output-file">Output file</a></li>
        <li><a href="#running-script">Running the script</a></li>
        <li><a href="#processing-steps">Processing steps</a></li>
        <li><a href="#roadway-metrics">Roadway metrics</a></li>
        <li><a href="#traffic-metrics">Traffic metrics</a></li>
        <li><a href="#safety-metrics">Safety metrics</a></li>
        <li><a href="#project-metrics">Project metrics</a></li>
      </ul>
    </li>
    <li>
      <a href="#dashboard-arcade">The Dashboard (Arcade Scripts)</a>
      <ul>
        <li><a href="#dashboard-usage">Dashboard usage</a></li>
        <li><a href="#arcade-scripts">ArcadeScripts reference</a></li>
      </ul>
    </li>
    <li>
      <a href="#adding-deleting-corridors">Adding or Deleting Corridors</a>
      <ul>
        <li><a href="#update-input-file">Update input file</a></li>
        <li><a href="#download-shields">Download highway shields</a></li>
        <li><a href="#generate-gpkg">Generate and publish GeoPackage</a></li>
      </ul>
    </li>
  </ul>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
    <svg viewBox="0 0 24 24" id="moon-icon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    <svg viewBox="0 0 24 24" id="sun-icon" style="display:none;"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
    <span id="theme-text">Dark Mode</span>
  </button>
</nav>

<main class="content">
<h1 id="overview">Corridor Profile Dashboard (Fort Worth District Transportation Master Plan): Data Pipeline Documentation</h1>

<div class="note">
  <strong>Dashboard URL:</strong> <a href="https://experience.arcgis.com/experience/bc4e6a538fa840e1931dfdec2154a455/page/Corridor-Profiles" target="_blank">https://experience.arcgis.com/experience/bc4e6a538fa840e1931dfdec2154a455/page/Corridor-Profiles</a>
</div>

<p>This document provides technical details for the Corridor Profile Dashboard data pipeline and dashboard logic. The backend process involves a Python script (<code>FWT_Corridors.py</code>) that aggregates segment-level roadway data into corridor-level statistics, performs spatial calculations, and enriches the data with project information from the District Project Tracker. The resulting data is then consumed by the ArcGIS Experience Builder dashboard using custom Arcade scripts for dynamic display and on-the-fly calculations.</p>

<h2 id="python-script">The Python Script</h2>

<h3 id="script-purpose">Script purpose</h3>

<p>The <code>FWT_Corridors.py</code> script performs the following tasks:</p>

<ul>
  <li><strong>Data Aggregation:</strong> Converts segment-level roadway data into corridor-level summaries</li>
  <li><strong>Spatial Calculations:</strong> Calculates corridor lengths and cross-section mileages using projected coordinates</li>
  <li><strong>Weighted Averages:</strong> Computes length-weighted averages for traffic metrics (AADT, Truck AADT, Tons)</li>
  <li><strong>Project Integration:</strong> Matches TxDOT projects to corridors and aggregates counts and costs by funding status</li>
  <li><strong>Dashboard Export:</strong> Generates a GeoPackage file optimized for ArcGIS Experience Builder consumption</li>
</ul>

<h3 id="input-files">Input files</h3>

<p>The script requires the following input files. <strong>If any input file is missing or has invalid structure, the script will stop with a clear error message.</strong></p>

<h3>1. FTW_Corridors.xlsx</h3>
<p><strong>Location:</strong> <code>Corridor_Profile/Input_Files/</code></p>
<p>Defines the corridors to process and their metadata.</p>
<p><strong>Required columns:</strong></p>
<ul>
  <li><code>Order</code> – Display order for corridors</li>
  <li><code>HWY_Code</code> – Highway code identifier</li>
  <li><code>HWY_Description</code> – Full highway description</li>
  <li><code>Corridor</code> – Corridor name (used for project matching)</li>
  <li><code>HWY_Label</code> – Highway label (used for segment matching)</li>
  <li><code>HWY_Shield</code> – Shield type for display</li>
</ul>

<h3>2. raptor_results_FTW.gpkg</h3>
<p><strong>Location:</strong> <code>Corridor_Profile/Input_Files/</code></p>
<p>Contains segment-level roadway data with geometry.</p>
<p><strong>Required columns:</strong></p>
<ul>
  <li><code>HWY</code> – Highway identifier (matched to HWY_Label from corridors Excel)</li>
  <li><code>Annual_Average_Daily_Traffic</code> – AADT values (renamed to <code>AADT</code> during processing)</li>
  <li><code>Truck_AADT</code> – Truck AADT values</li>
  <li><code>Truck_Tonnage</code> – Tonnage values (renamed to <code>Tons</code> during processing)</li>
  <li><code>Roadway_Cross_Section</code> – Cross-section type (e.g., "2L", "4U", "4D+")</li>
  <li><code>Number_Of_Crashes</code> – Crash counts per segment</li>
  <li><code>Number_Of_Fatal_Crashes</code> – Fatal crash counts per segment</li>
</ul>

<h3>3. FTW District Project Tracker - Master.xlsx</h3>
<p>Contains TxDOT project information for corridor enrichment.</p>
<p><code>J:\FTW District Transportation Master Plan - Documents\70_Shared_FTW_Deliverables\06_District_Project_List\FTW District Project Tracker - Master.xlsx</code></p>

<h4>Sheet: Under_Construction_June2025</h4>
<p>Contains projects currently under construction.</p>
<p><strong>Required columns:</strong></p>
<ul>
  <li><code>Highway</code> – Corridor name (matched to Corridor field in FTW_Corridors.xlsx)</li>
  <li><code>CSJ</code> – Control-Section-Job number (used for unique project counting)</li>
  <li><code>Construction Cost/Estimate</code> – Project cost</li>
</ul>

<h4>Sheet: UTP2026_TxC_Projects_Review</h4>
<p>Contains UTP 2026 projects with funding status. <strong>Note:</strong> This sheet is read with <code>header=1</code> (data starts on row 2).</p>
<p><strong>Required columns:</strong></p>
<ul>
  <li><code>Highway</code> – Corridor name (matched to Corridor field in FTW_Corridors.xlsx)</li>
  <li><code>TxDOT CONNECT CSJ (highlighted projects are in UTP)</code> – CSJ number (renamed to <code>CSJ</code> during processing)</li>
  <li><code>Funding Status (UTP 2026)</code> – Funding status ("Funded", "Partially Funded", or "Unfunded")</li>
  <li><code>Construction Cost</code> – Project construction cost</li>
  <li><code>Funding Gap</code> – Funding gap amount (used for partially funded projects)</li>
</ul>

<div class="note">
  <strong>Important:</strong> All input files are required. The script will fail with a clear error message if:
  <ul>
    <li>Any required input file is missing</li>
    <li>Any required sheet is missing from Excel files</li>
    <li>Any required column is missing from any input file</li>
    <li>Duplicate CSJs are found in the Project Tracker (each CSJ must be unique)</li>
  </ul>
</div>

<h3 id="output-file">Output file</h3>

<p>The script generates a single GeoPackage file:</p>

<ul>
  <li><strong>File:</strong> <code>FTW_Corridor_Profiles.gpkg</code></li>
  <li><strong>Location:</strong> <code>Corridor_Profile/Output_Files/</code></li>
  <li><strong>Layer:</strong> FTW_Corridor_Profiles</li>
  <li><strong>Contents:</strong> One feature per corridor with dissolved geometry and aggregated attributes</li>
</ul>

<h3>Output Columns</h3>
<p>The output GeoPackage contains the following columns (in order):</p>

<table>
  <tr>
    <th>Category</th>
    <th>Columns</th>
  </tr>
  <tr>
    <td>Corridor Metadata</td>
    <td>Order, HWY_Code, HWY_Description, Corridor, HWY_Shield</td>
  </tr>
  <tr>
    <td>Identifiers</td>
    <td>HWY</td>
  </tr>
  <tr>
    <td>Safety</td>
    <td>Number_Of_Crashes, Number_Of_Fatal_Crashes</td>
  </tr>
  <tr>
    <td>Traffic</td>
    <td>AADT, Truck_AADT, Tons, Truck_percentage</td>
  </tr>
  <tr>
    <td>Cross-Sections</td>
    <td>two_L_miles, four_U_plus_miles, four_D_plus_miles, etc.</td>
  </tr>
  <tr>
    <td>Mileage</td>
    <td>Total_Miles</td>
  </tr>
  <tr>
    <td>Construction Projects</td>
    <td>Projects_Construction, Project_Cost_Construction</td>
  </tr>
  <tr>
    <td>Funded Projects</td>
    <td>Projects_Funded, Project_Cost_Funded</td>
  </tr>
  <tr>
    <td>Partially Funded</td>
    <td>Projects_PartialFunded, Project_Cost_PartialFunded, Project_FundingGap_PartialFunded</td>
  </tr>
  <tr>
    <td>Unfunded Projects</td>
    <td>Projects_Unfunded, Project_Cost_Unfunded</td>
  </tr>
  <tr>
    <td>Geometry</td>
    <td>geometry (dissolved corridor line)</td>
  </tr>
</table>

<h3 id="running-script">Running the script</h3>

<div class="note">
  <strong>Prerequisites:</strong>
  <ul>
    <li>Python environment with <code>geopandas</code> and <code>pandas</code> installed</li>
    <li>Input files present in <code>Corridor_Profile/Input_Files/</code>:
      <ul>
        <li><code>FTW_Corridors.xlsx</code></li>
        <li><code>raptor_results_FTW.gpkg</code></li>
      </ul>
    </li>
    <li>FTW District Project Tracker - Master.xlsx file available</li>
    <li>Write access to <code>Corridor_Profile/Output_Files/</code></li>
  </ul>
</div>

<pre>python Corridor_Profile/Scripts/FWT_Corridors.py</pre>

<p>The script will display progress messages and complete with "Export complete." when successful.</p>

<h3 id="processing-steps">Processing steps</h3>

<p>The script performs the following operations in sequence:</p>

<h3>1. Load and Validate Data</h3>
<ul>
  <li>Read corridor definitions from <code>FTW_Corridors.xlsx</code></li>
  <li>Validate required columns exist (Order, HWY_Code, HWY_Description, Corridor, HWY_Label, HWY_Shield)</li>
  <li>Load segment data from <code>raptor_results_FTW.gpkg</code></li>
  <li>Validate required columns exist in GeoPackage</li>
  <li>Rename columns: <code>Annual_Average_Daily_Traffic</code> → <code>AADT</code>, <code>Truck_Tonnage</code> → <code>Tons</code></li>
  <li>Create corridor-to-HWY mapping for project matching</li>
</ul>

<h3>2. Filter and Reproject Data</h3>
<ul>
  <li>Filter segments to only those matching target corridors (by HWY field matching HWY_Label)</li>
  <li>Reproject geometry to EPSG:2276 (NAD83 / Texas North Central in feet)</li>
  <li>Calculate segment lengths in miles (length in feet / 5280)</li>
</ul>

<h3>3. Calculate Cross-Section Lengths</h3>
<ul>
  <li>Fill null Roadway_Cross_Section values with "Unknown"</li>
  <li>Group segments by HWY and Roadway_Cross_Section</li>
  <li>Sum segment lengths for each cross-section type</li>
  <li>Pivot to create columns with sanitized names for Arcade compatibility:
    <ul>
      <li>Replace <code>+</code> with <code>_plus</code></li>
      <li>Replace leading <code>2</code> with <code>two_</code></li>
      <li>Replace leading <code>4</code> with <code>four_</code></li>
      <li>Append <code>_miles</code> suffix</li>
    </ul>
  </li>
  <li>Example output columns: <code>two_L_miles</code>, <code>four_U_plus_miles</code>, <code>four_D_plus_miles</code></li>
</ul>

<h3>4. Compute Weighted Values and Sums</h3>
<ul>
  <li>Calculate weighted products for traffic metrics:
    <ul>
      <li><code>AADT_weighted</code> = AADT × segment_length_miles</li>
      <li><code>Truck_AADT_weighted</code> = Truck_AADT × segment_length_miles</li>
      <li><code>Tons_weighted</code> = Tons × segment_length_miles</li>
    </ul>
  </li>
  <li>Prepare aggregation for crash counts: <code>Number_Of_Crashes</code>, <code>Number_Of_Fatal_Crashes</code> (sum)</li>
</ul>

<h3>5. Dissolve Geometry and Calculate Weighted Averages</h3>
<ul>
  <li>Dissolve segment geometries by HWY to create one feature per corridor</li>
  <li>Aggregate weighted sums and crash counts during dissolve</li>
  <li>Calculate final weighted averages (avoiding division by zero):
    <ul>
      <li><code>AADT</code> = AADT_weighted_sum / segment_length_miles_sum (rounded to whole number)</li>
      <li><code>Truck_AADT</code> = Truck_AADT_weighted_sum / segment_length_miles_sum</li>
      <li><code>Tons</code> = Tons_weighted_sum / segment_length_miles_sum (rounded to 1 decimal)</li>
    </ul>
  </li>
  <li>Calculate <code>Truck_percentage</code> = (Truck_AADT / AADT) × 100 (rounded to 1 decimal)</li>
</ul>

<h3>6. Merge Corridor Data</h3>
<ul>
  <li>Merge cross-section pivot data by HWY</li>
  <li>Merge total miles by HWY</li>
  <li>Merge corridor metadata from Excel (Order, HWY_Code, HWY_Description, Corridor, HWY_Shield)</li>
</ul>

<h3>7. Integrate TxDOT Project Data</h3>
<ul>
  <li>Verify Project Tracker Excel file exists (fail if not found)</li>
  <li>Read project data from required sheets and validate data integrity:
    <ul>
      <li>Read <code>Under_Construction_June2025</code> sheet:
        <ul>
          <li>Validate no duplicate CSJs exist (fail if duplicates found)</li>
          <li>Filter projects matching target corridors by Highway field</li>
          <li>Map Highway to HWY using corridor-to-HWY mapping</li>
          <li>Count unique CSJs and sum Construction Cost/Estimate per HWY</li>
          <li>Create <code>Projects_Construction</code> and <code>Project_Cost_Construction</code></li>
        </ul>
      </li>
      <li>Read <code>UTP2026_TxC_Projects_Review</code> sheet (header=1):
        <ul>
          <li>Rename CSJ column from "TxDOT CONNECT CSJ (highlighted projects are in UTP)"</li>
          <li>Validate no duplicate CSJs exist (fail if duplicates found)</li>
          <li>Normalize Funding Status for case-insensitive matching</li>
          <li>Process Funded projects: Funding Status = "funded"</li>
          <li>Process Partially Funded projects: Funding Status contains "partial"</li>
          <li>Process Unfunded projects: Funding Status = "unfunded"</li>
          <li>Create project count and cost columns for each category</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Merge all project summaries into corridor data</li>
  <li>Fill NaN values with 0 for corridors without projects</li>
</ul>

<h3>8. Finalize and Export</h3>
<ul>
  <li>Reorder columns: Excel metadata first, computed metrics second, geometry last</li>
  <li>Convert numeric columns to Arcade-safe float64 types:
    <ul>
      <li>Integer-like columns: Number_Of_Crashes, Number_Of_Fatal_Crashes, Projects_*, Order</li>
      <li>Float columns: Project_Cost_*, Project_FundingGap_*</li>
    </ul>
  </li>
  <li>Export to <code>FTW_Corridor_Profiles.gpkg</code> with layer name "FTW_Corridor_Profiles"</li>
</ul>

<h3 id="roadway-metrics">Calculated metrics: Roadway</h3>

<h3>Total Corridor Length</h3>
<p>The total length of the corridor in miles, calculated by summing segment lengths after projecting to EPSG:2276 (NAD83 / Texas North Central in feet) and converting to miles.</p>
<div class="formula">Total_Miles = SUM(segment_length_feet) / 5280</div>
<p>Values are rounded to 1 decimal place.</p>

<h3>Cross-Section Lengths</h3>
<p>Miles of roadway by cross-section type, derived from the <code>Roadway_Cross_Section</code> field. Column names are sanitized for Arcade compatibility:</p>
<ul>
  <li><strong>2 Lanes:</strong> <code>two_L_miles</code> – Segments where Roadway_Cross_Section = "2L"</li>
  <li><strong>4 Lanes Undivided:</strong> <code>four_U_plus_miles</code> – Segments where Roadway_Cross_Section = "4U+"</li>
  <li><strong>4+ Lanes Divided:</strong> <code>four_D_plus_miles</code> – Segments where Roadway_Cross_Section = "4D+"</li>
  <li><strong>Unknown:</strong> <code>Unknown_miles</code> – Segments with null Roadway_Cross_Section</li>
</ul>
<p>All cross-section mileage values are rounded to 1 decimal place.</p>

<h3 id="traffic-metrics">Calculated metrics: Traffic</h3>

<h3>AADT (Annual Average Daily Traffic)</h3>
<p>Per-corridor AADT is a <strong>length-weighted average</strong> of segment-level AADT values:</p>
<div class="formula">AADT = SUM(segment_AADT × segment_miles) / SUM(segment_miles)</div>
<p>Values are rounded to whole numbers.</p>

<h3>Truck AADT</h3>
<p>Per-corridor Truck AADT is a <strong>length-weighted average</strong> of segment-level Truck_AADT values:</p>
<div class="formula">Truck_AADT = SUM(segment_Truck_AADT × segment_miles) / SUM(segment_miles)</div>

<h3>Truck Percentage</h3>
<p>Calculated from the weighted average values:</p>
<div class="formula">Truck_percentage = (Truck_AADT / AADT) × 100</div>
<p>Values are rounded to 1 decimal place. Returns null if AADT is zero or null.</p>

<h3>Tons (Truck Tonnage)</h3>
<p>Per-corridor Tons is a <strong>length-weighted average</strong> of segment-level tonnage values:</p>
<div class="formula">Tons = SUM(segment_Tons × segment_miles) / SUM(segment_miles)</div>
<p>Values are rounded to 1 decimal place.</p>

<h3 id="safety-metrics">Calculated metrics: Safety</h3>

<h3>Number of Crashes</h3>
<p>Total crash count for the corridor, calculated as a simple sum:</p>
<div class="formula">Number_Of_Crashes = SUM(segment_crashes)</div>

<h3>Number of Fatal Crashes</h3>
<p>Total fatal crash count for the corridor, calculated as a simple sum:</p>
<div class="formula">Number_Of_Fatal_Crashes = SUM(segment_fatal_crashes)</div>

<h3 id="project-metrics">Calculated metrics: Projects</h3>

<p>Project data is sourced from the FTW District Project Tracker Excel file and matched to corridors by the Highway field (matched against the Corridor field in FTW_Corridors.xlsx). Projects are counted by unique CSJ (Control-Section-Job) number.</p>


<h3>Under Construction</h3>
<p>Data from sheet: <code>Under_Construction_June2025</code></p>
<ul>
  <li><strong>Projects_Construction:</strong> Count of unique CSJs from the sheet</li>
  <li><strong>Project_Cost_Construction:</strong> Sum of "Construction Cost/Estimate" for those projects</li>
</ul>

<h3>Fully Funded</h3>
<p>Data from sheet: <code>UTP2026_TxC_Projects_Review</code> where Funding Status (UTP 2026) = "Funded" (case-insensitive)</p>
<ul>
  <li><strong>Projects_Funded:</strong> Count of unique CSJs</li>
  <li><strong>Project_Cost_Funded:</strong> Sum of "Construction Cost" for those projects</li>
</ul>

<h3>Partially Funded</h3>
<p>Data from sheet: <code>UTP2026_TxC_Projects_Review</code> where Funding Status (UTP 2026) contains "Partial" (case-insensitive)</p>
<ul>
  <li><strong>Projects_PartialFunded:</strong> Count of unique CSJs</li>
  <li><strong>Project_Cost_PartialFunded:</strong> Sum of "Construction Cost" for those projects</li>
  <li><strong>Project_FundingGap_PartialFunded:</strong> Sum of "Funding Gap" for those projects</li>
</ul>

<h3>Unfunded</h3>
<p>Data from sheet: <code>UTP2026_TxC_Projects_Review</code> where Funding Status (UTP 2026) = "Unfunded" (case-insensitive)</p>
<ul>
  <li><strong>Projects_Unfunded:</strong> Count of unique CSJs</li>
  <li><strong>Project_Cost_Unfunded:</strong> Sum of "Construction Cost" for those projects</li>
</ul>

<h2 id="dashboard-arcade">The Dashboard (Arcade Scripts)</h2>

<h3 id="dashboard-usage">Dashboard usage</h3>

<p>The output GeoPackage is consumed by an ArcGIS Experience Builder dashboard that displays corridor profiles. The dashboard uses ArcadeScripts to read and format the data.</p>

<h3>Individual Corridor View</h3>
<p>When a corridor is selected on the dashboard, the ArcadeScripts display the values directly from the corresponding row in the GeoPackage:</p>
<ul>
  <li>All metrics are read from the pre-calculated fields</li>
  <li>Values are formatted for display (commas, percentages, compact notation)</li>
</ul>

<h3>All Corridors View</h3>
<p>When no corridor is selected, the dashboard displays aggregated values. The aggregation is performed by ArcadeScripts at runtime:</p>

<h4>SUM Aggregations</h4>
<p>The following metrics use simple summation across all corridor rows:</p>
<ul>
  <li><strong>Mileage:</strong> Total_Miles, two_L_miles, four_U_plus_miles, four_D_plus_miles</li>
  <li><strong>Safety:</strong> Number_Of_Crashes, Number_Of_Fatal_Crashes</li>
  <li><strong>Projects:</strong> All project counts and costs</li>
</ul>

<h4>Weighted Average Aggregations</h4>
<p>Traffic metrics are re-weighted across all corridors:</p>
<div class="formula">
AADT_all = SUM(corridor_AADT × corridor_Total_Miles) / SUM(corridor_Total_Miles)<br>
Truck_AADT_all = SUM(corridor_Truck_AADT × corridor_Total_Miles) / SUM(corridor_Total_Miles)<br>
Tons_all = SUM(corridor_Tons × corridor_Total_Miles) / SUM(corridor_Total_Miles)<br>
Truck_percentage_all = (Truck_AADT_all / AADT_all) × 100
</div>


<h3 id="arcade-scripts">ArcadeScripts reference</h3>

<p>The dashboard calculations and display elements are implemented in ArcadeScripts located in <code>Corridor_Profile/Scripts/ArcadeScripts/</code>:</p>

<p>The following scripts are listed in the order they appear on the dashboard:</p>

<table>
  <tr>
    <th>Script</th>
    <th>Dashboard Display</th>
    <th>Aggregation Type</th>
  </tr>
  <tr><td colspan="3" class="category-title"><strong>Dashboard Title</strong></td></tr>
  <tr><td><code>corridor_title.js</code></td><td>Dynamic title (corridor name or "Fort Worth District Corridors with Greatest Needs")</td><td>Display Logic</td></tr>
  
  <tr><td colspan="3" class="category-title"><strong>Roadway Characteristics</strong></td></tr>
  <tr><td><code>total_miles.js</code></td><td>Total Corridor Length</td><td>SUM</td></tr>
  <tr><td><code>2L_miles.js</code></td><td>2 Lanes</td><td>SUM</td></tr>
  <tr><td><code>4U+_miles.js</code></td><td>4 Lanes Undivided</td><td>SUM</td></tr>
  <tr><td><code>4D+_miles.js</code></td><td>4+ Lane Divided</td><td>SUM</td></tr>
  
  <tr><td colspan="3" class="category-title"><strong>Traffic Metrics</strong></td></tr>
  <tr><td><code>AADT.js</code></td><td>Annual Average Daily Traffic</td><td>Weighted Avg</td></tr>
  <tr><td><code>Truck_AADT.js</code></td><td>Annual Average Daily Truck Traffic / Truck % / Tons</td><td>Weighted Avg</td></tr>
  
  <tr><td colspan="3" class="category-title"><strong>Safety Metrics</strong></td></tr>
  <tr><td><code>Number_Of_Crashes.js</code></td><td>Number of Crashes</td><td>SUM</td></tr>
  <tr><td><code>Number_Of_Fatal_Crashes.js</code></td><td>Number of Fatal Crashes</td><td>SUM</td></tr>
  
  <tr><td colspan="3" class="category-title"><strong>TxDOT Roadway Projects along the Corridor</strong></td></tr>
  <tr><td colspan="3"><em>Under Construction</em></td></tr>
  <tr><td><code>Projects_Construction.js</code></td><td>Number of Projects</td><td>SUM</td></tr>
  <tr><td><code>Project_Cost_Construction.js</code></td><td>Estimated Cost</td><td>SUM</td></tr>
  
  <tr><td colspan="3"><em>Fully Funded</em></td></tr>
  <tr><td><code>Projects_Funded.js</code></td><td>Number of Projects</td><td>SUM</td></tr>
  <tr><td><code>Project_Cost_Funded.js</code></td><td>Estimated Cost</td><td>SUM</td></tr>
  
  <tr><td colspan="3"><em>Partially Funded</em></td></tr>
  <tr><td><code>Projects_PartialFunded.js</code></td><td>Number of Projects</td><td>SUM</td></tr>
  <tr><td><code>Project_Cost_PartialFunded.js</code></td><td>Estimated Cost</td><td>SUM</td></tr>
  <tr><td><code>Project_FundingGap_PartialFunded.js</code></td><td>Funding Gap</td><td>SUM</td></tr>
  
  <tr><td colspan="3"><em>Unfunded</em></td></tr>
  <tr><td><code>Projects_Unfunded.js</code></td><td>Number of Projects</td><td>SUM</td></tr>
  <tr><td><code>Project_Cost_Unfunded.js</code></td><td>Estimated Cost</td><td>SUM</td></tr>
</table>

<h2 id="adding-deleting-corridors">Adding or Deleting Corridors</h2>

<p>This section describes the complete workflow for adding new corridors or removing existing corridors from the dashboard. The process involves updating the input spreadsheet, downloading highway shields, generating the GeoPackage, and publishing to ArcGIS Online.</p>

<h3 id="update-input-file">1. Update input file</h3>

<p>The first step is to modify the corridor definitions in the input Excel file.</p>

<p><strong>File:</strong> <code>Corridor_Profile/Input_Files/FTW_Corridors.xlsx</code></p>

<h4>Adding New Corridors</h4>
<ul>
  <li>Open <code>FTW_Corridors.xlsx</code> in Excel</li>
  <li>Add a new row for each corridor you want to add</li>
  <li>Fill in the required columns:
    <ul>
      <li><code>Order</code> – Display order number</li>
      <li><code>HWY_Code</code> – Highway code identifier</li>
      <li><code>HWY_Description</code> – Full highway description</li>
      <li><code>Corridor</code> – Corridor name (used for project matching)</li>
      <li><code>HWY_Label</code> – Highway label (used for segment matching and shield download)</li>
      <li><code>HWY_Shield</code> – Leave this column <strong>empty</strong> for new corridors</li>
    </ul>
  </li>
  <li>Save the file</li>
</ul>

<div class="note">
  <strong>Important:</strong> 
  <ul>
    <li>The <code>HWY_Label</code> field must match the <code>HWY</code> field in the <code>raptor_results_FTW.gpkg</code> file for the corridor data to be processed correctly.</li>
    <li>The <code>Corridor</code> field must match the <code>Highway</code> field in the FTW District Project Tracker Excel file for projects to be correctly matched and aggregated to each corridor.</li>
    <li>The <code>HWY_Shield</code> column should be left empty for new corridors—it will be automatically populated by the shield download script.</li>
  </ul>
</div>

<h4>Deleting Corridors</h4>
<ul>
  <li>Open <code>FTW_Corridors.xlsx</code> in Excel</li>
  <li>Delete the entire row(s) for the corridor(s) you want to remove</li>
  <li>Save the file</li>
</ul>

<h3 id="download-shields">2. Download highway shields</h3>

<p>After updating the corridor list, run the shield download script to automatically download highway shield images and update the spreadsheet with their URLs.</p>

<h4>Script: download_shields_wikipedia.py</h4>

<p><strong>Location:</strong> <code>Corridor_Profile/Scripts/download_shields_wikipedia.py</code></p>

<p><strong>Purpose:</strong> This script automates the process of downloading highway shield images from Wikimedia Commons and converting them to PNG format with standardized dimensions. It also updates the <code>HWY_Shield</code> column in the spreadsheet with GitHub URLs.</p>

<h4>What the script does:</h4>
<ol>
  <li><strong>Reads the spreadsheet:</strong> Extracts all unique highway labels from the <code>HWY_Label</code> column</li>
  <li><strong>Checks existing shields:</strong> Identifies which shields are already downloaded and validates their dimensions (must be exactly 500px height)</li>
  <li><strong>Downloads missing shields:</strong> For each missing shield, the script:
    <ul>
      <li>Builds the appropriate Wikimedia Commons URL based on the highway type (IH, US, SH, FM)</li>
      <li>Downloads the SVG file from Wikipedia</li>
      <li>Converts the SVG to PNG format at exactly 500px height (width varies to maintain aspect ratio)</li>
      <li>Tries multiple conversion methods: CairoSVG, ImageMagick, PNG thumbnail download, or Selenium</li>
    </ul>
  </li>
  <li><strong>Deletes extra shields:</strong> Removes any shield files that are no longer in the spreadsheet</li>
  <li><strong>Updates spreadsheet:</strong> Fills in the <code>HWY_Shield</code> column with GitHub URLs for all shields</li>
</ol>

<h4>Running the script:</h4>

<pre>cd Corridor_Profile/Scripts
python download_shields_wikipedia.py</pre>

<div class="note">
  <strong>Prerequisites:</strong>
  <ul>
    <li>Python environment with required packages: <code>pandas</code>, <code>openpyxl</code>, <code>requests</code>, <code>Pillow</code></li>
    <li>Optional but recommended: <code>cairosvg</code> for SVG conversion (most reliable method)</li>
    <li>The script will automatically handle missing converters and try alternative methods</li>
  </ul>
</div>

<h4>Script output:</h4>
<p>The script will display progress messages including:</p>
<ul>
  <li>Number of shields found in spreadsheet</li>
  <li>Number of shields already downloaded</li>
  <li>Download and conversion status for each shield</li>
  <li>Number of shields deleted (if any were removed from spreadsheet)</li>
  <li>Summary of all shields with dimensions and validation status</li>
</ul>

<h4>Output files:</h4>
<ul>
  <li><strong>Shield images:</strong> <code>Corridor_Profile/HWY_Shields/</code> – PNG files named by highway code (e.g., <code>IH0030.png</code>, <code>US0287.png</code>)</li>
  <li><strong>Updated spreadsheet:</strong> <code>FTW_Corridors.xlsx</code> – <code>HWY_Shield</code> column populated with GitHub URLs</li>
</ul>

<h3 id="generate-gpkg">3. Generate and publish GeoPackage</h3>

<p>After updating the corridor list and downloading shields, generate the final GeoPackage file and publish it to ArcGIS Online.</p>

<h4>Generate the GeoPackage:</h4>

<pre>cd Corridor_Profile/Scripts
python FWT_Corridors.py</pre>

<p>This will create the <code>FTW_Corridor_Profiles.gpkg</code> file in <code>Corridor_Profile/Output_Files/</code> with all the updated corridor data.</p>

<h4>Commit and push changes to GitHub:</h4>

<p>After successfully generating the GeoPackage, commit your changes to version control:</p>

<pre>git add Corridor_Profile/Input_Files/FTW_Corridors.xlsx
git add Corridor_Profile/HWY_Shields/*.png
git add Corridor_Profile/Output_Files/FTW_Corridor_Profiles.gpkg
git commit -m "Update corridors: [describe changes]"
git push origin main</pre>

<div class="note">
  <strong>Note:</strong> Replace <code>[describe changes]</code> with a brief description of what corridors were added or removed.
</div>

<h4>Publish to ArcGIS Online:</h4>

<ol>
  <li>Log in to ArcGIS Online</li>
  <li>Navigate to the <strong>Fort Worth</strong> group</li>
  <li>Locate the existing <code>FTW_Corridor_Profiles</code> feature layer</li>
  <li>Update the layer by uploading the new <code>FTW_Corridor_Profiles.gpkg</code> file:
    <ul>
      <li>Go to the layer's item details page</li>
      <li>Click <strong>Update Data</strong></li>
      <li>Select <strong>Overwrite Entire Layer</strong></li>
      <li>Upload the new GeoPackage file</li>
    </ul>
  </li>
  <li>Verify the update was successful</li>
</ol>

<h4>Dashboard automatically updates:</h4>

<p>Once the feature layer is updated in ArcGIS Online, the Experience Builder dashboard will automatically reflect the changes. No manual updates to the dashboard configuration are needed—the Arcade scripts will dynamically read the new corridor data.</p>

<div class="note">
  <strong>Summary of workflow:</strong>
  <ol>
    <li>Update <code>FTW_Corridors.xlsx</code> (add/delete corridors, leave <code>HWY_Shield</code> empty for new ones)</li>
    <li>Run <code>download_shields_wikipedia.py</code> to download shields and update spreadsheet</li>
    <li>Run <code>FWT_Corridors.py</code> to generate the GeoPackage</li>
    <li>Commit and push changes to GitHub</li>
    <li>Upload the new GeoPackage to ArcGIS Online (Fort Worth group)</li>
    <li>Dashboard updates automatically</li>
  </ol>
</div>

<div style="height: 40vh;"></div>
</main>

<script>
  // Theme Toggle Logic
  const themeToggle = document.getElementById('theme-toggle');
  const moonIcon = document.getElementById('moon-icon');
  const sunIcon = document.getElementById('sun-icon');
  const themeText = document.getElementById('theme-text');
  const html = document.documentElement;

  const updateThemeUI = (isDark) => {
    moonIcon.style.display = isDark ? 'none' : 'block';
    sunIcon.style.display = isDark ? 'block' : 'none';
    themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    html.setAttribute('data-theme', isDark ? 'dark' : 'light');
  };

  // Initialize theme
  const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  updateThemeUI(savedTheme === 'dark');

  themeToggle.addEventListener('click', () => {
    const isDark = html.getAttribute('data-theme') === 'dark';
    const newTheme = isDark ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    updateThemeUI(!isDark);
  });

  // Scroll Spy Logic
  const sections = document.querySelectorAll('h1[id], h2[id], h3[id]');
  const navLinks = document.querySelectorAll('.toc-list a');

  const observerOptions = {
    root: null,
    rootMargin: '0px 0px -80% 0px',
    threshold: 0
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('id');
        navLinks.forEach(link => {
          link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
        });
      }
    });
  }, observerOptions);

  sections.forEach(section => observer.observe(section));

  // Handle top and bottom edge cases
  window.addEventListener('scroll', () => {
    const scrollY = window.scrollY;
    const scrollPosition = window.innerHeight + scrollY;
    const bodyHeight = document.body.offsetHeight;

    // Very top of page
    if (scrollY <= 50) {
      const firstId = sections[0].getAttribute('id');
      navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === `#${firstId}`);
      });
      return;
    }

    // Very bottom of page
    if (scrollPosition >= bodyHeight - 200) {
      const lastId = sections[sections.length - 1].getAttribute('id');
      navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === `#${lastId}`);
      });
    }
  });
</script>
</body>
</html>
